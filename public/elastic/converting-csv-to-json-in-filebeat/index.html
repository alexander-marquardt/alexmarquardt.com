<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="light">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Converting CSV to JSON in Filebeat | Alexander Marquardt</title>
<meta name="keywords" content="csv, ingest, javascript, json">
<meta name="description" content="Introduction
Many organisations use excel files for creating and storing important data. For various reasons it may be useful to import such data into Elasticsearch. For example, one may need to get Master Data that is created in a spreadsheet into Elasticsearch where it could be used for enriching Elasticsearch documents. Or one may wish to use Elasticsearch and Kibana for analysing a dataset that is only available in a spreadsheet. In such cases, one option is to use Filebeat for uploading such CSV data into an Elasticsearch cluster.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/elastic/converting-csv-to-json-in-filebeat/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.2fe4dc5b52567b7454ee976e121c74370e14415db7564bb5ae6de9bd591821ff.css" integrity="sha256-L&#43;TcW1JWe3RU7pduEhx0Nw4UQV23Vku1rm3pvVkYIf8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/elastic/converting-csv-to-json-in-filebeat/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    }

</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Alexander Marquardt (Alt + H)">Alexander Marquardt</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Converting CSV to JSON in Filebeat
    </h1>
    <div class="post-meta"><span title='2020-03-17 00:00:00 +0000 UTC'>March 17, 2020</span>&nbsp;·&nbsp;<span>6 min</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#motivation" aria-label="Motivation">Motivation</a></li>
                <li>
                    <a href="#code" aria-label="Code">Code</a></li>
                <li>
                    <a href="#a-note-on-the-filebeat-registry" aria-label="A note on the Filebeat registry">A note on the Filebeat registry</a></li>
                <li>
                    <a href="#a-note-on-filebeat-processors" aria-label="A note on Filebeat processors">A note on Filebeat processors</a></li>
                <li>
                    <a href="#example-csv-input" aria-label="Example CSV input">Example CSV input</a></li>
                <li>
                    <a href="#filebeat-configuration" aria-label="Filebeat configuration">Filebeat configuration</a></li>
                <li>
                    <a href="#javascript-processor-code" aria-label="JavaScript processor code">JavaScript processor code</a></li>
                <li>
                    <a href="#executing-the-code" aria-label="Executing the code">Executing the code</a></li>
                <li>
                    <a href="#results" aria-label="Results">Results</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h1>
<p>Many organisations use excel files for creating and storing important data. For various reasons it may be useful to import such data into Elasticsearch. For example, one may need to get <a href="https://en.wikipedia.org/wiki/Master_data">Master Data</a> that is created in a spreadsheet into Elasticsearch where it could be used for <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/ingest-enriching-data.html">enriching Elasticsearch documents</a>. Or one may wish to use Elasticsearch and Kibana for analysing a dataset that is only available in a spreadsheet. In such cases, one option is to use <a href="https://www.elastic.co/guide/en/beats/filebeat/7.6/filebeat-overview.html">Filebeat</a> for uploading such CSV data into an Elasticsearch cluster.</p>
<p>In this blog I will show how Filebeat can be used to convert CSV data into JSON-formatted data that can be sent into an Elasticsearch cluster. This will be accomplished by using a built-in CSV processor as well as a custom JavaScript processor which will be applied to every line in a CSV file.</p>
<p>Note that Filebeat is intended for sending log lines into Elasticsearch. On the other hand, the technique described in this blog is <em>not intended</em> to run on a CSV file that continually has lines added to it.  The technique and code presented in this article is intended for ingesting an existing CSV file a single time, and it then terminates Filebeat immediately after the file has been ingested.</p>
<h1 id="motivation">Motivation<a hidden class="anchor" aria-hidden="true" href="#motivation">#</a></h1>
<p>Filebeat supports a <a href="https://www.elastic.co/guide/en/beats/filebeat/7.6/decode-csv-fields.html">CSV processor</a> which extracts values from a CSV string, and stores the result in an array. However, this processor does not create key-value pairs to maintain the relation between the column names and the extracted values. When using the CSV processor, additional processing (and hard-coding of the field names) is generally required in an <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/ingest.html">ingest node</a> or in <a href="https://www.elastic.co/guide/en/logstash/7.6/introduction.html">Logstash</a> to add the correct field names back into the extracted data.</p>
<p>On the other hand, the approach presented in this blog will automatically extract field names from the CSV header, and then generate key-value pairs based on each row’s values combined with the field names that are extracted from the header row. This technique therefore eliminates the need for additional ingest node or Logstash processing that would otherwise be required.</p>
<h1 id="code">Code<a hidden class="anchor" aria-hidden="true" href="#code">#</a></h1>
<p>All code presented in this blog is available at: <a href="https://github.com/alexander-marquardt/filebeat-csv-to-json">https://github.com/alexander-marquardt/filebeat-csv-to-json</a></p>
<h1 id="a-note-on-the-filebeat-registry">A note on the Filebeat registry<a hidden class="anchor" aria-hidden="true" href="#a-note-on-the-filebeat-registry">#</a></h1>
<p>Because Filebeat is designed for sending log lines from files which are actively being written, it keeps track of the most recent log entry that it has sent to Elasticsearch, and ensures that each entry is only sent once. This is tracked in the <a href="https://www.elastic.co/guide/en/beats/filebeat/7.6/configuration-general-options.html">Filebeat registry</a>. We should be aware the existence of the registry, as the registry will prevent sending the same CSV data to Elasticsearch multiple times, which can be undesirable when testing.</p>
<h1 id="a-note-on-filebeat-processors">A note on Filebeat processors<a hidden class="anchor" aria-hidden="true" href="#a-note-on-filebeat-processors">#</a></h1>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html">Processors</a> are executed on data as it passes through Filebeat. The code presented in this blog makes use of the <a href="https://www.elastic.co/guide/en/beats/filebeat/7.6/decode-csv-fields.html">CSV processor</a> as well as a custom <a href="https://www.elastic.co/guide/en/beats/filebeat/current/processor-script.html">script processor</a>. The custom script processor will apply custom JavaScript code to each event (in our case, to each to CSV line), which converts the CSV values into key-value pairs in a JSON object.</p>
<h1 id="example-csv-input">Example CSV input<a hidden class="anchor" aria-hidden="true" href="#example-csv-input">#</a></h1>
<p>We will store the following data in a file called <em>test.csv.</em> This file will be used to show how CSV can be converted into JSON. This CSV is intentionally written in an inconsistent format, to ensure that the code is working correctly for different formats:</p>
<pre tabindex="0"><code>first_col,col2,col3,fourth_col
1234,&#34;first 1&#34;,123,third 1
5678,first 2,456,&#34;third 2&#34;
</code></pre><h1 id="filebeat-configuration">Filebeat configuration<a hidden class="anchor" aria-hidden="true" href="#filebeat-configuration">#</a></h1>
<p>We use the following <em>filebeat.yml</em> configuration to call the CSV processor as well as our custom JavaScript.</p>
<pre tabindex="0"><code>max_procs: 1 # This code will not work correctly on multiple threads
 
filebeat.inputs:
- type: log
  enabled: true
  close_eof: true
  paths:
    - ${PWD}/test.csv

  processors:
  - decode_csv_fields:
      fields:
        message: decoded_csv_arr
      separator: &#34;,&#34;
      ignore_missing: false
      overwrite_keys: true
      trim_leading_space: false
      fail_on_error: true

  - script:
      lang: javascript
      id: convert_csv_into_json
      file: ${PWD}/convert_csv_to_json.js

  - drop_fields:
      fields: [&#34;decoded_csv_arr&#34;]

output.elasticsearch:
  hosts: [&#34;localhost:9200&#34;]

  index: &#34;csv_to_json-%{+YYYY.MM.dd}&#34; 

setup.ilm.enabled: false
setup.template.enabled: false
</code></pre><h1 id="javascript-processor-code">JavaScript processor code<a hidden class="anchor" aria-hidden="true" href="#javascript-processor-code">#</a></h1>
<p>Below we present the JavaScript code that we use for converting lines in a CSV file into JSON objects. This should be stored in a file called <em>convert_csv_to_json.js</em> which is referenced in the <em>filebeat.yml</em> configuration that we presented above.</p>
<p>When the first line of CSV is passed into this JavaScript processor, the code uses a <a href="https://www.w3schools.com/js/js_function_closures.asp">JavaScript closure</a> to “remember” the header values. When subsequent lines from the CSV file are passed in, the headers are combined with the values in each row to create key-value pairs that are stored in a JSON object.</p>
<p>Note that this will only work as a single threaded process since the closure containing the header fields is only available in the thread that processes the header row. This is ensured by setting <em>max_procs: 1</em> in <em>filebeat.yml</em>.</p>
<pre tabindex="0"><code>// This function takes an array containing the field names, and another that
// contains field values, and returns a json dictionary that combines them.
function convert_csv_to_dict(csv_headers_row, csv_values_row) {
  var json_from_csv =  csv_values_row.reduce(function(result, field, index) {
    result[csv_headers_row[index]] = field;
    return result;
  }, {})

  return json_from_csv;
}

// Define the JavaScript function that will be used to combine the 
// header row with subsequent rows in the CSV file
var headers_fn = (function() {
  var csv_headers_row = null; 

  // Use a JavaScript closure to store the header line (csv_headers_row), 
  // so that we can use the header values for all subsequent CSV entries. 
  return function(csv_arr) {

    var json_from_csv = null;

    if (!csv_headers_row) {
      // if this is the first row, store the headers
      csv_headers_row = csv_arr;
    } else {
      // combine the csv_headers_row with the values to get a dict
      json_from_csv = convert_csv_to_dict(csv_headers_row, csv_arr)
    }
    return json_from_csv;
  }

})();  

// This function is called for each &#34;event&#34; 
// (eg. called once for each line in the log file)
function process(event) {
    var csv_arr = event.Get(&#34;decoded_csv_arr&#34;);
    var json_from_csv = headers_fn(csv_arr);

    // If the current event was triggered to process the header row,
    // then the json_from_csv will be empty - it only returns a json dict
    // for subsequent rows. Cancel the event so that nothing
    // is sent to the output.
    if (!json_from_csv) {
      event.Cancel();
    }
    event.Put(&#34;json_from_csv&#34;, json_from_csv);
}
</code></pre><h1 id="executing-the-code">Executing the code<a hidden class="anchor" aria-hidden="true" href="#executing-the-code">#</a></h1>
<p>The following command line can be used for executing the code which converts the CSV into JSON, and then sends the resulting documents into Elasticsearch.</p>
<pre tabindex="0"><code>rm -rf my_reg; ./filebeat  -once -E filebeat.registry.path=${PWD}/my_reg
</code></pre><p>There are a few things to point out about this command line.</p>
<ol>
<li>It deletes the registry directory before executing filebeat. This means that the input file will be sent each time that Filebeat is executed. To prevent multiple copies of the same document from appearing in the destination index, the destination index should be deleted before running this code.</li>
<li>It is storing the registry in the local directory, which makes it easier to find and delete it.</li>
<li>It is running with the “-once” option, which makes filebeat exit once the command has completed.</li>
</ol>
<h1 id="results">Results<a hidden class="anchor" aria-hidden="true" href="#results">#</a></h1>
<p>Once the above code has executed, there should be an index written into Elasticsearch that starts with &ldquo;csv_to_json-&rdquo;. Looking into this index, we can see that the documents contain the following field, which has been extracted from the CSV file.</p>
<pre tabindex="0"><code>&#34;json_from_csv&#34; : {
  &#34;col3&#34; : &#34;123&#34;,
  &#34;fourth_col&#34; : &#34;third 1&#34;,
  &#34;first_col&#34; : &#34;1234&#34;,
  &#34;col2&#34; : &#34;first 1&#34;
}
</code></pre><h1 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h1>
<p>In this blog, I have shown how filebeat can be used to convert CSV data into JSON objects in the documents that are sent to Elasticsearch. Because the field names in the JSON object are extracted directly from the CSV file, this technique eliminates the need for either ingest nodes or Logstash which would otherwise be required for adding the correct field names to the CSV data.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/csv/">Csv</a></li>
      <li><a href="http://localhost:1313/tags/ingest/">Ingest</a></li>
      <li><a href="http://localhost:1313/tags/javascript/">Javascript</a></li>
      <li><a href="http://localhost:1313/tags/json/">Json</a></li>
    </ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Alexander Marquardt</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

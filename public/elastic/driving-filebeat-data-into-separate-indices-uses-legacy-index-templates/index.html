<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Driving Filebeat data into separate indices (uses legacy index templates) | Alexander Marquardt</title>
<meta name="keywords" content="">
<meta name="description" content="Introduction
When driving data into Elasticsearch from Filebeat, the default behaviour is for all data to be sent into the same destination index regardless of the source of the data. This may not always be desirable since data from different sources may have different access requirements , different retention policies, or different ingest processing requirements.
In this post, we&rsquo;ll use Filebeat to send data from separate sources into multiple indices, and then we&rsquo;ll use index lifecycle management (ILM), legacy index templates, and a custom ingest pipeline to further control that data.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/elastic/driving-filebeat-data-into-separate-indices-uses-legacy-index-templates/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.16015f91a66b46ba261d7a8bdc4ebc41b1453d8387302aef098118ac6f00fe06.css" integrity="sha256-FgFfkaZrRromHXqL3E68QbFFPYOHMCrvCYEYrG8A/gY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/elastic/driving-filebeat-data-into-separate-indices-uses-legacy-index-templates/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Alexander Marquardt (Alt + H)">
                <img src="http://localhost:1313/alexmarquardt.png" alt="" aria-label="logo"
                    height="30">Alexander Marquardt</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Driving Filebeat data into separate indices (uses legacy index templates)
    </h1>
    <div class="post-meta"><span title='2021-03-15 00:00:00 +0000 UTC'>March 15, 2021</span>

</div>
  </header> 
  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>When driving data into <a href="https://www.elastic.co/elasticsearch/">Elasticsearch</a> from <a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-overview.html">Filebeat</a>, the default behaviour is for all data to be sent into the same destination index regardless of the source of the data. This may not always be desirable since data from different sources may have different access requirements , different retention policies, or different ingest processing requirements.</p>
<p>In this post, we&rsquo;ll use Filebeat to send data from separate sources into multiple indices, and then we&rsquo;ll use <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-lifecycle-management.html">index lifecycle management (ILM)</a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/indices-templates-v1.html"><em>legacy</em> index templates</a>, and a <a href="https://www.elastic.co/blog/new-way-to-ingest-part-1">custom ingest pipeline</a> to further control that data.</p>
<p><em>If you are interested in using the newer <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/index-templates.html">composable templates</a> and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/data-streams.html">data streams</a> to control your Filebeat data, see the blog <a href="https://www.elastic.co/blog/how-to-manage-elasticsearch-data-multiple-indices-filebeat-ilm-data-streams">How to manage Elasticsearch data across multiple indices with Filebeat, ILM, and data streams</a>.</em></p>
<h2 id="driving-different-data-types-into-different-destinations">Driving different data types into different destinations<a hidden class="anchor" aria-hidden="true" href="#driving-different-data-types-into-different-destinations">#</a></h2>
<p>You may have several different types of data that may be collected by filebeat, such as “source1”, “source2”, etc. As these may have different access/security requirements and/or different retention requirements it may be useful to drive data from different sources into different filebeat indices.</p>
<p><em>Keep in mind that splitting the filebeat data into different destinations adds complexity to the deployment. For many customers, the default behaviour of driving all filebeat data into a single destination pattern is acceptable and does not require the custom configuration that we outline below.</em></p>
<h2 id="step-1---create-aliases">Step 1 - Create alias(es)<a hidden class="anchor" aria-hidden="true" href="#step-1---create-aliases">#</a></h2>
<p>Each destination &ldquo;index&rdquo; that we will specify in Filebeat will actually be an <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/indices-aliases.html">alias</a> so that <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index-lifecycle-management.html">index lifecycle management (ILM)</a> will work correctly.</p>
<p>We can create an alias that will work with the Filebeat configuration that we give later in this blog, as follows:</p>
<pre tabindex="0"><code>PUT filebeat-7.10.2-source1-000001
{
  &#34;aliases&#34;: {
    &#34;filebeat-7.10.2-source1&#34;: {
      &#34;is_write_index&#34;: true
    }
  }
}
</code></pre><p>You would want to do the same for other data sources (eg. source2, etc).</p>
<p>In the above alias, by naming the index filebeat-7.10.2-source1, which includes the version number after the word filebeat, we ensure that the default template that is pushed into the cluster by filebeat will be applied to the index.</p>
<h2 id="step-2---define-an-ilm-policy">Step 2 - Define an ILM policy<a hidden class="anchor" aria-hidden="true" href="#step-2---define-an-ilm-policy">#</a></h2>
<p>You should define the index lifecycle management policy (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/getting-started-index-lifecycle-management.html">see this link</a> for instructions).</p>
<p>A single policy can be used by multiple indices, or you can define a new policy for each index. In the next section, I assume that you have created a policy called &ldquo;filebeat-policy&rdquo;.</p>
<h2 id="step-3---ensure-that-ilm-will-use-the-correct-rollover-alias">Step 3 - Ensure that ILM will use the correct rollover alias<a hidden class="anchor" aria-hidden="true" href="#step-3---ensure-that-ilm-will-use-the-correct-rollover-alias">#</a></h2>
<p>In order for ILM to automate rolling over of indices, we define the rollover alias that will be used. This can be done by creating a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates-v1.html#put-index-template-v1-api-query-params">high-order template</a> (that overwrites the lower-order templates) so that each unique data type will have a unique rollover alias. For example, the following template can be used to ensure that the source1 data rolls over correctly:</p>
<pre tabindex="0"><code>PUT _template/filebeat-7.10.2-source1-ilm
{
  &#34;order&#34;: 50,
  &#34;index_patterns&#34;: [
    &#34;filebeat-7.10.2-source1-*&#34;
  ],
  &#34;settings&#34;: {
    &#34;index&#34;: {
      &#34;lifecycle&#34;: {
        &#34;name&#34;: &#34;filebeat-policy&#34;,
        &#34;rollover_alias&#34;: &#34;filebeat-7.10.2-source1&#34;
      }
    }
  }
}
</code></pre><h2 id="step-4---optional-define-a-custom-ingest-pipeline">Step 4 - (Optional) Define a custom ingest pipeline<a hidden class="anchor" aria-hidden="true" href="#step-4---optional-define-a-custom-ingest-pipeline">#</a></h2>
<p>Below is an example of a very simple ingest pipeline that we can use to modify documents that are ingested into Elasticsearch. As we will see in the next section, this can selectively be applied to data from different sources depending on the destination index name.</p>
<p>If the ingest pipeline has a failure in it, then the document that triggered the failure is rejected. This is likely undesirable, and may be enhanced by including on_failure error handling into the pipeline code as shown below:</p>
<pre tabindex="0"><code>PUT _ingest/pipeline/my_custom_pipeline
{
  &#34;description&#34;: &#34;Put your custom ingest pipeline code here&#34;,
  &#34;processors&#34;: [
    {
      &#34;set&#34;: {
        &#34;field&#34;: &#34;my-new-field&#34;,
        &#34;value&#34;: &#34;some new value&#34;,
        &#34;on_failure&#34;: [
          {
            &#34;set&#34;: {
              &#34;field&#34;: &#34;error.message&#34;,
              &#34;value&#34;: &#34;my_custom_pipeline failed to execute set - {{ _ingest.on_failure_message }}&#34;
            }
          }
        ]
      }
    }
  ],
  &#34;on_failure&#34;: [
    {
      &#34;set&#34;: {
        &#34;field&#34;: &#34;error.message&#34;,
        &#34;value&#34;: &#34;Uncaught failure in my_custom_pipeline: {{ _ingest.on_failure_message }}&#34;
      }
    }
  ]
}
</code></pre><h2 id="step-5---optional-execution-of-the-custom-ingest-pipeline">Step 5 - (Optional) Execution of the custom ingest pipeline<a hidden class="anchor" aria-hidden="true" href="#step-5---optional-execution-of-the-custom-ingest-pipeline">#</a></h2>
<p>The following template will ensure that our ingest pipeline will be executed against all documents arriving to indices that match the specified index patterns.</p>
<p>Be sure to modify the index patterns below to include all of the index names that should have our custom pipeline applied.</p>
<pre tabindex="0"><code>PUT _template/filebeat-template-to-call-my-custom-processors
{
  &#34;order&#34;: 51,
  &#34;index_patterns&#34;: [
    &#34;filebeat-*-source1-*&#34;,
    &#34;filebeat-*-source2-*&#34;
  ],
  &#34;settings&#34;: {
    &#34;index&#34;: {
      &#34;final_pipeline&#34;: &#34;my_custom_pipeline&#34;
    }
  },
  &#34;mappings&#34;: {},
  &#34;aliases&#34;: {}
}
</code></pre><p>Notice that we have used <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/index-modules.html#dynamic-index-settings">final_pipeline</a> rather than <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/index-modules.html#dynamic-index-settings">default_pipeline</a>. This is to ensure that calling our custom pipeline does not override any of the default Filebeat pipelines that may be called by various Filebeat modules.</p>
<h2 id="step-6---filebeat-code-to-drive-data-into-different-destination-indices">Step 6 - Filebeat code to drive data into different destination indices<a hidden class="anchor" aria-hidden="true" href="#step-6---filebeat-code-to-drive-data-into-different-destination-indices">#</a></h2>
<p>The following filebeat code can be used as an example of how to drive documents into different destination index aliases. Note that if the alias does not exist, then filebeat will create an index with the specified name rather than driving into an alias with the specified name, which is undesirable. Therefore, defining the alias as shown in Step 1 of this blog should be done before running filebeat with this configuration.</p>
<p>The example below would drive data into an alias (or index) called filebeat-7.10.2-source1 (assuming we are running Filebeat version 7.10.2).</p>
<pre tabindex="0"><code>filebeat.inputs:
- type: log
 enabled: true
 paths:
   - /tmp/&lt;path to your input&gt;.txt
 fields_under_root: true
 fields:
   data_type: &#34;source1&#34;

setup.template.enabled: true
setup.template.name: &#34;filebeat-%{[agent.version]}&#34;
setup.template.pattern: &#34;filebeat-%{[agent.version]}-*&#34;
setup.template.fields: &#34;fields.yml&#34;
setup.template.overwrite: false
setup.ilm.enabled: false # we handle ILM in the cluster, so not defined here

output.elasticsearch:
 hosts: [&#34;localhost:9200&#34;]
 indices:
   - index: &#34;filebeat-%{[agent.version]}-%{[data_type]}&#34;
</code></pre><p>In the above example, there are several setup.template settings which will ensure that the default filebeat templates are loaded correctly into the cluster if they do not already exist. See <a href="https://www.elastic.co/guide/en/beats/filebeat/current/configuration-template.html">configure elasticsearch index template loading</a> for more information.</p>
<h2 id="upgrading-filebeat">Upgrading filebeat<a hidden class="anchor" aria-hidden="true" href="#upgrading-filebeat">#</a></h2>
<p>Once you have implemented the above, then when upgrading to a new version of filebeat you will have to ensure that a new index alias is pointing to the correct underlying indices (re-execute step 1), and that ILM will use the correct alias (re-execute step 3). If these steps are done, then the new version of filebeat should be able to execute the same filebeat.yml that we have defined above in step 6 without modification.</p>
<h2 id="appendix-1---code-for-testing-the-ingest-pipeline">Appendix 1 - code for testing the ingest pipeline<a hidden class="anchor" aria-hidden="true" href="#appendix-1---code-for-testing-the-ingest-pipeline">#</a></h2>
<p>The pipeline below will send two documents into the pipeline given in Step 4. This can be used for validating that the pipeline is behaving as expected.</p>
<pre tabindex="0"><code>POST _ingest/pipeline/my_custom_pipeline/_simulate
{
  &#34;docs&#34;: [
    {
      &#34;_source&#34;: {
        &#34;message&#34;: &#34;this is doc 1&#34;
      }
    },
    {
      &#34;_source&#34;: {
        &#34;message&#34;: &#34;this is doc 2&#34;
      }
    }
  ]
}
</code></pre><h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>In this post, I showed how to use Filebeat to send data from separate sources into multiple indices, and how to use index lifecycle management (ILM), <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.11/indices-templates-v1.html"><em>legacy</em> index templates</a>, and a <a href="https://www.elastic.co/blog/new-way-to-ingest-part-1">custom ingest pipeline</a> to further control that data.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Alexander Marquardt</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>

<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Using Logstash and Elasticsearch scripted upserts to transform eCommerce purchasing data | Alexander Marquardt</title>
<meta name="keywords" content="">
<meta name="description" content="Introduction
Logstash is a tool that can be used to collect, process, and forward events to Elasticsearch. In order to demonstrate the power of Logstash when used in conjunction with Elasticsearch’s scripted upserts, I will show you how to create a near-real-time entity-centric index. Once data is transformed into an entity-centric index, many kinds of analysis become possible with simple (cheap) queries rather than more computationally intensive aggregations.
As a note, using the approach demonstrated here would result in documents similar to those generated by Elasticsearch transforms. Nevertheless, the technique that is documented has not been benchmarked against Elasticsearch transforms, as the main goal of this blog is to demonstrate the power and flexibility of Logstash combined with scripted upserts.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/elastic/logstash-and-elasticsearch-painless-scripted-upserts-transform-data/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.16015f91a66b46ba261d7a8bdc4ebc41b1453d8387302aef098118ac6f00fe06.css" integrity="sha256-FgFfkaZrRromHXqL3E68QbFFPYOHMCrvCYEYrG8A/gY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/elastic/logstash-and-elasticsearch-painless-scripted-upserts-transform-data/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Alexander Marquardt (Alt + H)">
                <img src="http://localhost:1313/alexmarquardt.png" alt="" aria-label="logo"
                    height="30">Alexander Marquardt</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Using Logstash and Elasticsearch scripted upserts to transform eCommerce purchasing data
    </h1>
    <div class="post-meta"><span title='2019-12-17 00:00:00 +0000 UTC'>December 17, 2019</span>

</div>
  </header> 
  <div class="post-content"><h1 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h1>
<p><a href="https://www.elastic.co/guide/en/logstash/7.5/introduction.html">Logstash</a> is a tool that can be used to collect, process, and forward events to Elasticsearch. In order to demonstrate the power of Logstash when used in conjunction with Elasticsearch’s <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/docs-update.html#scripted_upsert">scripted upserts</a>, I will show you how to create a near-real-time <a href="https://www.elastic.co/elasticon/2015/sf/building-entity-centric-indexes">entity-centric index</a>. Once data is transformed into an entity-centric index, many kinds of analysis become possible with simple (cheap) queries rather than more computationally intensive aggregations.</p>
<p>As a note, using the approach demonstrated here would result in documents similar to those generated by <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/transforms.html">Elasticsearch transforms</a>. Nevertheless, the technique that is documented has not been benchmarked against Elasticsearch transforms, as the main goal of this blog is to demonstrate the power and flexibility of Logstash combined with scripted upserts.</p>
<h1 id="motivation">Motivation<a hidden class="anchor" aria-hidden="true" href="#motivation">#</a></h1>
<p>Scripted upserts are very powerful and flexible as they allow custom <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/modules-scripting-painless.html">Painless</a> code to be executed on each document as it is being upserted. However, in my experience, scripted upserts are not commonly used. I believe this may possibly be due to a lack of end-to-end examples. This blog aims to address this shortcoming by providing one such example.</p>
<p>In this blog I will provide an example that shows how Logstash can execute scripted upserts to transform data. This will achieve functionality similar to what is demonstrated in the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ecommerce-transforms.html">tutorial on how to use transforms</a>. The Elasticsearch <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/transforms.html">documentation on transforms</a> explains why one might wish to transform data as follows:</p>
<blockquote>
<p>“A lot of Elasticsearch indices are organized as a stream of events: each event is an individual document, for example a single item purchase. Transforms enable you to summarize this data, bringing it into an organized, more analysis-friendly format. For example, you can summarize all the purchases of a single customer in a single document.”</p>
</blockquote>
<p>As stated earlier, transforming data into an entity-centric view makes many kinds of analysis possible using simple (cheap) queries rather than more expensive aggregations. For example, if the total value of all purchases for a given customer are transformed so that they are contained in a single document, then it becomes very efficient to query and/or order customers by their total spending. On the contrary, if each purchase were contained in a separate document, then more computationally intensive aggregations would have to be executed to extract the same results.</p>
<h1 id="using-logstash-and-scripted-upserts-to-transform-the-sample-ecommerce-data">Using Logstash and scripted upserts to transform the sample eCommerce data<a hidden class="anchor" aria-hidden="true" href="#using-logstash-and-scripted-upserts-to-transform-the-sample-ecommerce-data">#</a></h1>
<p>Because the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ecommerce-transforms.html">eCommerce transform tutorial</a> is clearly described and because the <a href="https://www.elastic.co/guide/en/kibana/7.5/add-sample-data.html">sample eCommerce data</a> data is readily available, we implement similar functionality in this blog post to demonstrate the power and flexibility of scripted upserts. </p>
<p>In our example we use Logstash to read data from Elasticsearch, which is done only for demonstration purposes. Normally Logstash would receive data as an externally generated data stream.</p>
<h2 id="script-for-upserting-the-transformed-data">Script for upserting the transformed data<a hidden class="anchor" aria-hidden="true" href="#script-for-upserting-the-transformed-data">#</a></h2>
<p>Below is a script that computes several of the same metrics as those described in the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ecommerce-transforms.html">eCommerce transforms tutorial</a>. We accomplish this by creating a single document for each client that will be updated each time a new purchase is made by that client. This will store a running total of the <em>taxless_total_price.sum</em> and of the <em>total_quantity.sum</em> fields. Additionally, we place a conditional to only update the <em>total_quantity.max</em> field if it has a value that is greater than the previously stored value.</p>
<pre tabindex="0"><code>POST _scripts/transform_ecommerce
{
  &#34;script&#34;: {
  &#34;lang&#34;: &#34;painless&#34;,
  &#34;source&#34;: &#34;&#34;&#34;
  
      // If new, then initialize relevant fields.
      if (&#34;create&#34;.equals(ctx.op)) {
          ctx._source[&#39;total_quantity&#39;] = new HashMap();
          ctx._source[&#39;taxless_total_price&#39;] = new HashMap();
          
          ctx._source[&#39;total_quantity&#39;][&#39;sum&#39;] = 0;
          ctx._source[&#39;total_quantity&#39;][&#39;max&#39;] = 0;
          ctx._source[&#39;taxless_total_price&#39;][&#39;sum&#39;] = (double)0;
      }
      
      // compute some of the metrics from the eCommerce 
      // transforms demo
      ctx._source[&#39;total_quantity&#39;][&#39;sum&#39;] += params.event[&#39;total_quantity&#39;];
      ctx._source[&#39;taxless_total_price&#39;][&#39;sum&#39;] += (double)params.event[&#39;taxless_total_price&#39;];
      if (params.event[&#39;total_quantity&#39;] &gt; ctx._source[&#39;total_quantity&#39;][&#39;max&#39;]) {
        ctx._source[&#39;total_quantity&#39;][&#39;max&#39;] = params.event[&#39;total_quantity&#39;];
      }
    &#34;&#34;&#34;
  }
}
</code></pre><h2 id="mappings-for-the-transformed-index">Mappings for the transformed index<a hidden class="anchor" aria-hidden="true" href="#mappings-for-the-transformed-index">#</a></h2>
<p>Set the mapping for the scripted upsert transformed index as follows:</p>
<pre tabindex="0"><code>// if it exists, delete it first
DELETE ecommerce_ls_transformed

PUT /ecommerce_ls_transformed
{
  &#34;mappings&#34;: {
    &#34;properties&#34;: {
      &#34;customer_id&#34;: {
        &#34;type&#34;: &#34;keyword&#34;
      },
      &#34;taxless_total_price&#34;: {
        &#34;properties&#34;: {
          &#34;sum&#34;: {
            &#34;type&#34;: &#34;double&#34;
          }
        }
      },
      &#34;total_quantity&#34;: {
        &#34;properties&#34;: {
          &#34;max&#34;: {
            &#34;type&#34;: &#34;integer&#34;
          },
          &#34;sum&#34;: {
            &#34;type&#34;: &#34;integer&#34;
          }
        }
      }
    }
  }
}
</code></pre><h2 id="test-the-upsert-script">Test the upsert script<a hidden class="anchor" aria-hidden="true" href="#test-the-upsert-script">#</a></h2>
<p>We can test the above script before attempting to use it in Logstash. Notice that we are sending the update values to the script in <em>params.event</em>, which is the how <a href="https://www.elastic.co/guide/en/logstash/7.5/plugins-outputs-elasticsearch.html#plugins-outputs-elasticsearch-script_var_name">Logstash sends scripted upsert data</a> by default. The following update operation can be used to test the previously defined <em>transform_ecommerce</em> script:</p>
<pre tabindex="0"><code>POST test_script/_doc/454/_update
{
  &#34;scripted_upsert&#34;: true,
  &#34;script&#34;: {
    &#34;id&#34;: &#34;transform_ecommerce&#34;,
    &#34;params&#34;: {
      &#34;event&#34;: {
        &#34;total_quantity&#34;: 1,
        &#34;taxless_total_price&#34;: 80.25
      }
    }
  },
  &#34;upsert&#34;: {}
}
</code></pre><h2 id="set-mappings-for-the-copy-of-the-ecommerce-index">Set mappings for the copy of the eCommerce index<a hidden class="anchor" aria-hidden="true" href="#set-mappings-for-the-copy-of-the-ecommerce-index">#</a></h2>
<p>Copy the mappings from the <em>kibana_sample_data_ecommerce</em> index into the <em>ecommerce_copy</em> index. Setting the mapping on the <em>ecommerce_copy</em> index can be done by pasting the mappings from <em>kibana_sample_data_ecommerce</em> as follows:</p>
<pre tabindex="0"><code>// if it exists, remove the old copy
DELETE ecommerce_copy

GET kibana_sample_data_ecommerce/_mappings

PUT ecommerce_copy
{
  &#34;mappings&#34;: {
     // paste mappings from kibana_sample_data_ecommerce
 }
}
</code></pre><h2 id="define-the-logstash-pipeline">Define the Logstash pipeline<a hidden class="anchor" aria-hidden="true" href="#define-the-logstash-pipeline">#</a></h2>
<p>In the approach documented here, each Logstash event will be driven into two Logstash outputs &ndash; one output will drive each event into a “raw” Elasticsearch index (i.e. into an index containing a document corresponding to each Logstash event), and the other output will drive that same event into a transformed index which will be updated based on a subset of the event’s contents.</p>
<p>Below is the Logstash pipeline that will be used for re-ingesting the eCommerce documents, as well as for generating the transformed index. The transformed index will be called <em>ecommerce_ls_transformed</em> and the original documents will be stored in the index called <em>ecommerce_copy</em>.  Store the logstash pipeline below in a file called <em>logstash-transform.conf</em>.</p>
<pre tabindex="0"><code>input {
  elasticsearch {
    hosts =&gt; &#34;localhost&#34;
    index =&gt; &#34;kibana_sample_data_ecommerce&#34;
    query =&gt; &#39;{ &#34;query&#34;: { &#34;match_all&#34;: {} } }&#39;
  }
}

output {

  # Transformed data
  elasticsearch {
    index =&gt; &#34;ecommerce_ls_transformed&#34;
    document_id =&gt; &#34;%{customer_id}&#34;
    action =&gt; &#34;update&#34;
    scripted_upsert =&gt; true
    script_lang =&gt; &#34;&#34;
    script_type =&gt; &#34;indexed&#34;
    script =&gt; &#34;transform_ecommerce&#34;
  }

  # Original data
  elasticsearch {
    index =&gt; &#34;ecommerce_copy&#34;
  }
}
</code></pre><h2 id="run-logstash">Run Logstash<a hidden class="anchor" aria-hidden="true" href="#run-logstash">#</a></h2>
<p>Depending on the directory layout, the above pipeline can be executed with a command similar to the following:</p>
<pre tabindex="0"><code>./bin/logstash -f ./config/logstash-transform.conf
</code></pre><h2 id="view-the-copy-of-the-ecommerce-data">View the copy of the eCommerce data<a hidden class="anchor" aria-hidden="true" href="#view-the-copy-of-the-ecommerce-data">#</a></h2>
<p>After executing the pipeline, the <em>ecommerce_copy</em> index should contain copies of the documents from the <em>kibana_sample_data_ecommerce</em> index. It can be viewed as follows:</p>
<pre tabindex="0"><code>GET ecommerce_copy/_search
</code></pre><h2 id="view-the-transformed-data">View the transformed data<a hidden class="anchor" aria-hidden="true" href="#view-the-transformed-data">#</a></h2>
<p>The transformed data is in the <em>ecommerce_ls_transformed</em> index, and can be viewed in the same order as the data in the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ecommerce-transforms.html">transform tutorial</a> by executing the following query:</p>
<pre tabindex="0"><code>GET ecommerce_ls_transformed/_search
{
  &#34;sort&#34;: [
    {
      &#34;_id&#34;: {
        &#34;order&#34;: &#34;asc&#34;
      }
    }
  ]
}
</code></pre><p>The first document returned from the above query should be the following:</p>
<pre tabindex="0"><code>{
   &#34;_index&#34; : &#34;ecommerce_ls_transformed&#34;,
   &#34;_type&#34; : &#34;_doc&#34;,
   &#34;_id&#34; : &#34;10&#34;,
   &#34;_score&#34; : null,
   &#34;_source&#34; : {
   &#34;total_quantity&#34; : {
     &#34;max&#34; : 2,
     &#34;sum&#34; : 118
   },
   &#34;taxless_total_price&#34; : {
     &#34;sum&#34; : 3946.8200000000006
   }
}
</code></pre><p>Notice that the values in <em>ecommerce_ls_transformed</em> match quite closely with the values computed in the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ecommerce-transforms.html">transform tutorial</a> - the <em>total_quanitity</em> values in the first document match perfectly with the tutorial, and the <em>taxless_total_price.sum</em> is very close &ndash; <em>3946.8200000000006</em> versus <em>3946.9765625</em> in the transform tutorial. Presumably this small difference is due to floating-point rounding errors.</p>
<h1 id="filtering-data-in-logstash">Filtering data in Logstash<a hidden class="anchor" aria-hidden="true" href="#filtering-data-in-logstash">#</a></h1>
<p>An astute reader many have noticed that the above approach is sending the full Logstash event to each of the Elasticsearch outputs, even though the <em>ecommerce_ls_transformed</em> index only requires a few fields. The <a href="https://www.elastic.co/blog/using-logstash-to-split-data-and-send-it-to-multiple-outputs">blog about splitting Logstash data</a> demonstrates how to filter the data that is sent to each Elasticsearch index.</p>
<h1 id="caveats">Caveats<a hidden class="anchor" aria-hidden="true" href="#caveats">#</a></h1>
<p>There are a few caveats that should be considered if the scripted update approach is used:</p>
<ul>
<li>Even if the original event document is ingested, there is a possibility that the associated scripted update fails on the transformed document. This could create an inconsistent view of the data.</li>
<li>If there is a stream of data that would trigger many scripted upserts on a single document in a short time period, then this approach may break down due to an overwhelming number of conflicting updates on that document.</li>
<li>The <a href="https://www.elastic.co/guide/en/logstash/7.5/plugins-outputs-elasticsearch.html#_retry_policy">Logstash retry policy</a>  and Elasticsearch <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/docs-update.html">retry_on_conflict</a> should be understood and set appropriately. More information is available in this documentation about <a href="https://www.elastic.co/guide/en/elasticsearch/guide/2.x/partial-updates.html#_updates_and_conflicts">updates and conflicts</a>.</li>
<li>If a raw document is deleted, the associated transformed document will not reflect this change.</li>
<li>Every update on a document writes a new document to Elasticsearch. Therefore, this approach which indexes the original raw document as well as upserting the transformed document, will effectively double the ingest workload when compared to the ingest workload of only indexing the raw documents.</li>
</ul>
<h1 id="conclusions">Conclusions<a hidden class="anchor" aria-hidden="true" href="#conclusions">#</a></h1>
<p>In this blog we have demonstrated how Logstash can be used in conjunction with <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/docs-update.html#scripted_upsert">scripted upserts</a>. In order to demonstrate this functionality, we explored how Logstash events can be used to create a near-real-time <a href="https://www.elastic.co/elasticon/2015/sf/building-entity-centric-indexes">entity-centric</a> view of indexed data. The approach demonstrated here only touches the surface of the capabilities of scripted upserts, and because scripted upserts are based on <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/modules-scripting-painless.html">Painless</a>, custom functionality can be <em>painlessly</em> implemented.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Alexander Marquardt</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>

<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="light">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Using Logstash to scan inside event contents to replace sensitive data with a consistent hash | Alexander Marquardt</title>
<meta name="keywords" content="">
<meta name="description" content="Introduction
Logstash is commonly used for transforming data before it is sent to another system for storage, and so it is often well positioned for finding and replacing sensitive text, as may be required for GDPR compliance.
Therefore, in this blog I show how Logstash can make use of a ruby filter to scan through the contents of an event and to replace each occurrence of sensitive text with the value of its hash.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/elastic/using-logstash-to-scan-inside-event-contents-to-replace-sensitive-data-with-a-consistent-hash/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.2fe4dc5b52567b7454ee976e121c74370e14415db7564bb5ae6de9bd591821ff.css" integrity="sha256-L&#43;TcW1JWe3RU7pduEhx0Nw4UQV23Vku1rm3pvVkYIf8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/elastic/using-logstash-to-scan-inside-event-contents-to-replace-sensitive-data-with-a-consistent-hash/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    }

</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Alexander Marquardt (Alt + H)">Alexander Marquardt</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Using Logstash to scan inside event contents to replace sensitive data with a consistent hash
    </h1>
    <div class="post-meta"><span title='2022-01-20 00:00:00 +0000 UTC'>January 20, 2022</span>&nbsp;·&nbsp;<span>3 min</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#acknowledgement" aria-label="Acknowledgement">Acknowledgement</a></li>
                <li>
                    <a href="#code-description" aria-label="Code description">Code description</a></li>
                <li>
                    <a href="#logstash-pipeline" aria-label="Logstash pipeline">Logstash pipeline</a></li>
                <li>
                    <a href="#executing-the-pipeline" aria-label="Executing the pipeline">Executing the pipeline</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p><a href="https://www.elastic.co/logstash/">Logstash</a> is commonly used for transforming data before it is sent to another system for storage, and so it is often well positioned for finding and replacing sensitive text, as may be required for GDPR compliance.</p>
<p>Therefore, in this blog I show how Logstash can make use of a ruby filter to scan through the contents of an event and to replace <em>each occurrence</em> of sensitive text with the value of its hash.</p>
<p>This is done by making use of Ruby&rsquo;s <a href="https://ruby-doc.org/core-2.4.2/String.html#method-i-gsub">gsub</a> functionality, providing a definition of a regular expression pattern that will be replaced (in this blog, we demonstrate with an email address regex pattern), and by executing a hash function to calculate the replacement value.</p>
<p>Note that the use case addressed in this blog is different than the use cases for the <a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-fingerprint.html">fingerprint filter</a>. The fingerprint filter can combine and hash one or more fields, but it does not analyze or replace substrings inside the field(s).</p>
<p>This blog also demonstrates several other Logstash concepts, including:</p>
<ol>
<li>Use of a generator in Logstash to automatically create new events to make testing of your filters quick and easy.</li>
<li>Defining custom ruby code inside your Logstash pipeline.</li>
<li>Use of the stdout output to easily debug your Logstash pipeline.</li>
<li>Automatic reload functionality to allow you to immediately validate any code changes that you make in your Logstash pipeline.</li>
</ol>
<h2 id="acknowledgement">Acknowledgement<a hidden class="anchor" aria-hidden="true" href="#acknowledgement">#</a></h2>
<p>Thanks to my co-worker Joao Duarte at Elastic for coming up with the custom ruby filter that is presented in this blog.</p>
<h2 id="code-description">Code description<a hidden class="anchor" aria-hidden="true" href="#code-description">#</a></h2>
<p>The code given below demonstrates an entire Logstash pipeline that creates a simulated input event that contains a message with multiple email addresses in it. It then processes the event with a custom ruby filter which finds and replaces each email addresses in the &ldquo;message&rdquo; field with its SHA1 digest, and then writes the modified event to stdout.</p>
<h2 id="logstash-pipeline">Logstash pipeline<a hidden class="anchor" aria-hidden="true" href="#logstash-pipeline">#</a></h2>
<pre tabindex="0"><code>input {
    generator {
        lines =&gt; [
            &#39;{&#34;message&#34;: &#34;Someone had an email address foobar@example.com and sent mail to foobaz@another-example.com&#34;}&#39;
        ]
        count =&gt; 1
        codec =&gt; &#34;json&#34;
    }
}

filter {
  ruby {
    init =&gt; &#34;require &#39;digest&#39;; @email_regex = /([a-zA-Z0-9_\-\.]+)@([a-zA-Z0-9_\-\.]+)\.([a-zA-Z]{2,5})/&#34;
    code =&gt; &#34;str = event.get(&#39;message&#39;); event.set(&#39;message&#39;, str.gsub(@email_regex) {|v| Digest::SHA1.hexdigest(v) })&#34;
  } 
}

output {
    stdout { codec =&gt; &#34;rubydebug&#34; }
}
</code></pre><h2 id="executing-the-pipeline">Executing the pipeline<a hidden class="anchor" aria-hidden="true" href="#executing-the-pipeline">#</a></h2>
<p>The above pipeline can be executed with the following command line, which will automatically restart the pipeline each time it is modified:</p>
<pre tabindex="0"><code>./bin/logstash -f &lt;your pipeline config file&gt; --config.reload.automatic
</code></pre><p>This will generate the following output, which confirms that the email addresses in the message field (of the event created in the generator) have been replaced with the SHA1 hash value, as desired:</p>
<pre tabindex="0"><code>{
      &#34;@version&#34; =&gt; &#34;1&#34;,
          &#34;host&#34; =&gt; &#34;New2020MacBook.lan&#34;,
       &#34;message&#34; =&gt; &#34;Someone had an email address 6f25d1a16b65ee184e83d06a268af7f44d4e8a10 and sent mail to f1377593215966404efb0f42c6ce48017c2c5522&#34;,
    &#34;@timestamp&#34; =&gt; 2022-01-20T17:50:10.598Z,
      &#34;sequence&#34; =&gt; 0
}
</code></pre><h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>In this brief post, I have demonstrated the following concepts:</p>
<ol>
<li>How to use a generator to create a custom event to help easily verify the functionality of your Logstash filters and to help debug your Logstash pipeline.</li>
<li>How to define a custom Ruby filter in your Logstash pipeline.</li>
<li>How to make use of Ruby&rsquo;s gsub functionality along with a regular expression and a call to a SHA1.hexdigest function, for replacing sensitive text.</li>
<li>How to view the resulting modified events on stdout.</li>
<li>How to automatically reload your pipeline as your make edits.</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Alexander Marquardt</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

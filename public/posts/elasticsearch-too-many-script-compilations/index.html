<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="light">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Understanding and fixing &#34;too many script compilations&#34; errors in Elasticsearch | Alexander Marquardt</title>
<meta name="keywords" content="">
<meta name="description" content="Introduction
When using Elasticsearch, in some rare instances you may see an error such as &ldquo;Too many dynamic script compilations within X minutes&rdquo;. Such an error may be caused by a poor script design where parameters are hard-coded. In other cases this may be due to the script cache being too small or the compilation limit being too low. In this article, I will show how to determine if these default limits are too low, and how these limits can be modified.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/elasticsearch-too-many-script-compilations/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css" integrity="sha256-NDzEgLn/yPBMy&#43;XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/elasticsearch-too-many-script-compilations/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    }

</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Alexander Marquardt (Alt + H)">Alexander Marquardt</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Understanding and fixing &#34;too many script compilations&#34; errors in Elasticsearch
    </h1>
    <div class="post-meta"><span title='2020-10-21 00:00:00 +0000 UTC'>October 21, 2020</span>&nbsp;·&nbsp;<span>4 min</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#warning" aria-label="Warning">Warning</a></li>
                <li>
                    <a href="#script-caching" aria-label="Script caching">Script caching</a></li>
                <li>
                    <a href="#deprecated-script-settings-read-this-if-you-are-running-78-or-earlier" aria-label="Deprecated script settings (Read this if you are running 7.8 or earlier)">Deprecated script settings (Read this if you are running 7.8 or earlier)</a></li>
                <li>
                    <a href="#script-settings-in-elasticsearch-79-and-newer" aria-label="Script settings in Elasticsearch 7.9 and newer">Script settings in Elasticsearch 7.9 and newer</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a></li>
                <li>
                    <a href="#acknowledgement" aria-label="Acknowledgement">Acknowledgement</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>When using Elasticsearch, in some rare instances you may see an error such as &ldquo;Too many dynamic script compilations within X minutes&rdquo;. Such an error may be caused by a poor script design <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting-using.html#prefer-params">where parameters are hard-coded</a>. In other cases this may be due to the script cache being too small or the compilation limit being too low. In this article, I will show how to determine if these default limits are too low, and how these limits can be modified.</p>
<h2 id="warning">Warning<a hidden class="anchor" aria-hidden="true" href="#warning">#</a></h2>
<p>In this blog I will show you how to change default settings used for caching scripts Elasticsearch. Changing these to very large values may impact cluster performance and in the worst case could even cause your cluster to crash.</p>
<h2 id="script-caching">Script caching<a hidden class="anchor" aria-hidden="true" href="#script-caching">#</a></h2>
<p>Scripts are cached by default so that they only need to be recompiled when updates occur. However, as these scripts are stored in a <em>cache</em>, if the cache gets filled up, then some of the previously compiled scripts will be removed from the cache and would need to be recompiled again if they are needed in the future. For more information, see the documentation on <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting-using.html#modules-scripting-using-caching">script caching</a>.</p>
<h2 id="deprecated-script-settings-read-this-if-you-are-running-78-or-earlier">Deprecated script settings (Read this if you are running 7.8 or earlier)<a hidden class="anchor" aria-hidden="true" href="#deprecated-script-settings-read-this-if-you-are-running-78-or-earlier">#</a></h2>
<p>Versions of Elasticsearch 7.8 and earlier <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.8/modules-scripting-using.html#_script_parameters">will compile up to 15 inline scripts per minute</a>. These compiled scripts are then stored in the script cache which by default <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.8/modules-scripting-using.html#modules-scripting-using-caching">can store up to 100 scripts</a>.</p>
<p>The statistics for the script cache can be viewed with the following command:</p>
<pre tabindex="0"><code>GET /_nodes/stats?metric=script&amp;filter_path=nodes.*.script.* 
</code></pre><p>Which should respond with something similar to the following:</p>
<pre tabindex="0"><code>{
  &#34;nodes&#34; : {
    &#34;XfXvXJ7xSLynbdZBsFwG3A&#34; : {
      &#34;script&#34; : {
        &#34;compilations&#34; : 28,
        &#34;cache_evictions&#34; : 0,
        &#34;compilation_limit_triggered&#34; : 0
      }
    },
    &#34;pzrnXnehTrKEN0urD7j9eg&#34; : {
      &#34;script&#34; : {
        &#34;compilations&#34; : 407081,
        &#34;cache_evictions&#34; : 406981,
        &#34;compilation_limit_triggered&#34; : 5176579
      }
    }
    ... etc ...
</code></pre><p>The numbers shown are counted since the last restart of each node. If the <code>compilations</code> and <code>cache_evictions</code> have large numbers or are constantly increasing, this may indicate that the cache is churning, and may therefore indicate that the cache is too small.</p>
<p>A high value for <code>compilation_limit_triggered</code> may be a side effect of having a cache that is too small, or possibly poor script design <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting-using.html#prefer-params">where parameters are hard-coded</a> .</p>
<p>The script cache may be configured by setting <code>script.cache.max_size</code> in the <code>elasticsearch.yml</code> configuration file as follows.</p>
<pre tabindex="0"><code>script.cache.max_size: 300
</code></pre><p>And you can dynamically set <code>script.max_compilations_rate</code> as follows:</p>
<pre tabindex="0"><code>PUT _cluster/settings
{
  &#34;persistent&#34;: {
    &#34;script.max_compilations_rate&#34;: &#34;250/5m&#34;
  }
}
</code></pre><p>However both of these settings are  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.9.html#breaking_79_script_cache_changes">now deprecated</a>.</p>
<h2 id="script-settings-in-elasticsearch-79-and-newer">Script settings in Elasticsearch 7.9 and newer<a hidden class="anchor" aria-hidden="true" href="#script-settings-in-elasticsearch-79-and-newer">#</a></h2>
<p>Starting in Elasticsearch 7.9, by default scripts are stored depending on the contexts which they execute in. Contexts allow different defaults to be set for different kinds of scripts that Elasticsearch may execute. There are many contexts available, such as &ldquo;watcher_transform&rdquo;, &ldquo;bucket aggregation&rdquo;, &ldquo;aggs_combine&rdquo;, and many others. For those adventurous enough to look in the source code, instantiation of contexts can be seen with <a href="https://github.com/elastic/elasticsearch/search?p=1&amp;q=%22new+ScriptContext%22">this search on GitHub</a>.</p>
<p>Contexts are enabled by default starting in 7.9. However, if contexts (for some reason) are not currently enabled, they can be enabled with the following command:</p>
<pre tabindex="0"><code>PUT _cluster/settings
{
    &#34;persistent&#34;: {
        &#34;script.max_compilations_rate&#34;: &#34;use-context&#34;
    }
}
</code></pre><p>If contexts are used, they can be viewed with the following command:</p>
<pre tabindex="0"><code>GET /_nodes/stats?filter_path=nodes.*.script_cache.contexts
</code></pre><p>This should respond with a list of the contexts that are used for executing scripts, such as the following:</p>
<pre tabindex="0"><code>    {
        &#34;nodes&#34; : {
          &#34;lqxteGihTpifU5lvV7BEmg&#34; : {
            &#34;script_cache&#34; : {
            &#34;contexts&#34; : [
                {
                    &#34;context&#34; : &#34;aggregation_selector&#34;,
                    &#34;compilations&#34; : 1,
                    &#34;cache_evictions&#34; : 0,
                    &#34;compilation_limit_triggered&#34; : 0
                }

                 ... etc ...
        
                {
                   &#34;context&#34; : &#34;xpack_template&#34;,
                   &#34;compilations&#34; : 0,
                   &#34;cache_evictions&#34; : 0,
                   &#34;compilation_limit_triggered&#34; : 0
                 }
            
                 .... etc ...
</code></pre><p>If the response above is empty, then &ldquo;use-context&rdquo; may not be enabled, and can be enabled as described above.</p>
<p>As with previous versions of Elasticsearch, if the <code>compilations</code> and <code>cache_evictions</code> have large numbers or are constantly increasing, this may indicate that the cache is churning, and may be an indicator that the cache is too small.</p>
<p>For most contexts, you can compile up to 75 scripts per 5 minutes by default. For ingest contexts, the default script compilation rate is unlimited. For most contexts, the default cache size is 100. For ingest contexts, the default cache size is 200. These defaults are given in the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-scripting-using.html#prefer-params">7.9 documentation on how to use scripts</a>.</p>
<p>You can set <code>script.context.$CONTEXT.cache_max_size</code> in the <code>elasticsearch.yml</code> configuration file. For example, to set the max size for the <code>xpack_template</code> context, you would add the following to <code>elasticsearch.yml</code>.</p>
<pre tabindex="0"><code>script.context.xpack_template.cache_max_size: 300
</code></pre><p>On the other hand,<code>script.context.$CONTEXT.max_compilations_rate</code> may be set dynamically. For example you can configure the compilations rate for the <code>xpack_template</code> context as follows:</p>
<pre tabindex="0"><code>PUT _cluster/settings
{
    &#34;persistent&#34;: {
        &#34;script.context.xpack_template.max_compilations_rate&#34;: &#34;150/5m&#34;
    }
}
</code></pre><h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>In this blog, I have shown how you can look deeper into Elasticsearch to try to diagnose the potential cause of script compilation errors, and how to modify default settings if necessary.</p>
<h2 id="acknowledgement">Acknowledgement<a hidden class="anchor" aria-hidden="true" href="#acknowledgement">#</a></h2>
<p>Thanks to my Elastic colleague Michael Bischoff for providing guidance on how to investigate and fix the &ldquo;too many script compilations within X minutes&rdquo; issue.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/using-elasticsearch-painless-scripting-to-iterate-through-fields/">
    <span class="title">« Prev</span>
    <br>
    <span>Using Elasticsearch Painless scripting to recursively iterate through JSON fields</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/using-logstash-and-elasticsearch-scripted-upserts-to-calculate-transaction-duration-from-out-of-order-events/">
    <span class="title">Next »</span>
    <br>
    <span>Using Logstash and Elasticsearch to calculate transaction duration in a microservices architecture</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Alexander Marquardt</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

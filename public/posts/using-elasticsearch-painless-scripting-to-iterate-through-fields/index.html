<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="light">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Using Elasticsearch Painless scripting to recursively iterate through JSON fields | Alexander Marquardt</title>
<meta name="keywords" content="">
<meta name="description" content="Authors

Alexander Marquardt
Honza Kral

Introduction
Painless is a simple, secure scripting language designed specifically for use with Elasticsearch. It is the default scripting language for Elasticsearch and can safely be used for inline and stored scripts. In one of its many use cases, Painless can modify documents as they are ingested into your Elasticsearch cluster. In this use case, you may find that you would like to use Painless to evaluate every field in each document that is received by Elasticsearch. However, because of the hierarchical nature of JSON documents, how to iterate over all of the fields may be non-obvious.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/using-elasticsearch-painless-scripting-to-iterate-through-fields/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css" integrity="sha256-NDzEgLn/yPBMy&#43;XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/using-elasticsearch-painless-scripting-to-iterate-through-fields/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    }

</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Alexander Marquardt (Alt + H)">Alexander Marquardt</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Using Elasticsearch Painless scripting to recursively iterate through JSON fields
    </h1>
    <div class="post-meta"><span title='2020-11-06 00:00:00 +0000 UTC'>November 6, 2020</span>&nbsp;·&nbsp;<span>4 min</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#authors" aria-label="Authors">Authors</a></li>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#example-one---remove-empty-fields" aria-label="Example one - remove empty fields">Example one - remove empty fields</a></li>
                <li>
                    <a href="#example-two---remove-fields-where-the-field-name-matches-a-regular-expression" aria-label="Example two - remove fields where the field name matches a regular expression">Example two - remove fields where the field name matches a regular expression</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="authors">Authors<a hidden class="anchor" aria-hidden="true" href="#authors">#</a></h2>
<ul>
<li>Alexander Marquardt</li>
<li>Honza Kral</li>
</ul>
<h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p><em><a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting-painless.html">Painless</a></em> is a simple, secure scripting language designed specifically for use with Elasticsearch. It is the default scripting language for Elasticsearch and can safely be used for inline and stored scripts. In one of its many use cases, Painless can modify documents as they are ingested into your Elasticsearch cluster. In this use case, you may find that you would like to use Painless to evaluate every field in each document that is received by Elasticsearch. However, because of the hierarchical nature of JSON documents, how to iterate over all of the fields may be non-obvious.</p>
<p>This blog provides examples that demonstrate how Painless can iterate across all fields in each document that Elasticsearch receives, regardless of wheather fields appear directly in the top-level JSON body, or if they are contained in sub-documents or arrays.</p>
<h2 id="example-one---remove-empty-fields">Example one - remove empty fields<a hidden class="anchor" aria-hidden="true" href="#example-one---remove-empty-fields">#</a></h2>
<p>The following painless script called &ldquo;remove_empty_fields&rdquo; shows how to loop over all elements in a document, and deletes each field where the value is an empty string.</p>
<pre tabindex="0"><code>PUT _ingest/pipeline/remove_empty_fields
 {
   &#34;processors&#34;: [
     {
       &#34;script&#34;: {
         &#34;lang&#34;: &#34;painless&#34;,
         &#34;source&#34;: &#34;&#34;&#34;

           void iterateAllFields(def x) {
             if (x instanceof List) {
               for (def v: x) {
                 iterateAllFields(v);
               }
             }
             if (!(x instanceof Map)) {
               return;
             }
             x.entrySet().removeIf(e -&gt; e.getValue() == &#34;&#34;);
             for (def v: x.values()) {
               iterateAllFields(v);
             }
           }

           iterateAllFields(ctx);
       &#34;&#34;&#34;
       }
     }
   ]
 }
</code></pre><p>Notice that we use <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#removeIf-java.util.function.Predicate-">removeIf</a> in the above code, which will correctly remove fields with an empty string as a value. Using a more naive approach with a for loop to iterate over the fields returned by &ldquo;x.entrySet()&rdquo; and then executing <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#remove-java.lang.Object-">remove</a> statement within the for loop to directly delete an element will result in a &ldquo;ConcurrentModfiicationException&rdquo;, as you cannot modify the Map as it is being looped over.</p>
<p>We can test the above script with the following call to the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/simulate-pipeline-api.html">simulate pipeline API</a> as follows.</p>
<pre tabindex="0"><code>POST _ingest/pipeline/remove_empty_fields/_simulate
 {
   &#34;docs&#34;: [
     {
       &#34;_source&#34;: {
         &#34;key1&#34;: &#34;first value&#34;,
         &#34;key2&#34;: &#34;some other value&#34;,
         &#34;key3&#34;: &#34;&#34;,
         &#34;sudoc&#34;: {
           &#34;a&#34;: &#34;abc&#34;,
           &#34;b&#34;: &#34;&#34;
         }
       }
     },
     {
       &#34;_source&#34;: {
         &#34;key1&#34;: &#34;&#34;,
         &#34;key2&#34;: &#34;some other value&#34;,
         &#34;list_of_docs&#34;: [
           {
             &#34;foo&#34;: &#34;abc&#34;,
             &#34;bar&#34;: &#34;&#34;
           },
           {
             &#34;baz&#34;: &#34;&#34;,
             &#34;subdoc_in_list&#34;: {&#34;child1&#34;: &#34;xxx&#34;, &#34;child2&#34;: &#34;&#34;}
           }
         ]
       }
     }
   ]
 }
</code></pre><p>Which will return the following results, where each field that contains an empty string has been removed.</p>
<pre tabindex="0"><code>{
   &#34;docs&#34; : [
     {
       &#34;doc&#34; : {
         &#34;_index&#34; : &#34;_index&#34;,
         &#34;_type&#34; : &#34;_doc&#34;,
         &#34;_id&#34; : &#34;_id&#34;,
         &#34;_source&#34; : {
           &#34;key1&#34; : &#34;first value&#34;,
           &#34;key2&#34; : &#34;some other value&#34;,
           &#34;sudoc&#34; : {
             &#34;a&#34; : &#34;abc&#34;
           }
         },
         &#34;_ingest&#34; : {
           &#34;timestamp&#34; : &#34;2020-11-06T10:59:29.105406Z&#34;
         }
       }
     },
     {
       &#34;doc&#34; : {
         &#34;_index&#34; : &#34;_index&#34;,
         &#34;_type&#34; : &#34;_doc&#34;,
         &#34;_id&#34; : &#34;_id&#34;,
         &#34;_source&#34; : {
           &#34;list_of_docs&#34; : [
             {
               &#34;foo&#34; : &#34;abc&#34;
             },
             {
               &#34;subdoc_in_list&#34; : {
                 &#34;child1&#34; : &#34;xxx&#34;
               }
             }
           ],
           &#34;key2&#34; : &#34;some other value&#34;
         },
         &#34;_ingest&#34; : {
           &#34;timestamp&#34; : &#34;2020-11-06T10:59:29.105411Z&#34;
         }
       }
     }
   ]
 }
</code></pre><h2 id="example-two---remove-fields-where-the-field-name-matches-a-regular-expression">Example two - remove fields where the field name matches a regular expression<a hidden class="anchor" aria-hidden="true" href="#example-two---remove-fields-where-the-field-name-matches-a-regular-expression">#</a></h2>
<p>The following painless script called &ldquo;remove_unwanted_keys&rdquo; shows how you can remove keys with a name that match a regular expression. In this example, we delete any fields where the field name starts with &ldquo;unwanted_key_&rdquo;.</p>
<p>Note that by default regexes are disabled. To load this script you will first need to set &ldquo;script.painless.regex.enabled&rdquo; to &ldquo;true&rdquo; in &ldquo;elasticsearch.yml&rdquo;.</p>
<pre tabindex="0"><code>PUT _ingest/pipeline/remove_unwanted_keys
 {
   &#34;processors&#34;: [
     {
       &#34;script&#34;: {
         &#34;lang&#34;: &#34;painless&#34;,
         &#34;source&#34;: &#34;&#34;&#34;

           void iterateAllFields(def x) {
             if (x instanceof List) {
               for (def v: x) {
                 iterateAllFields(v);
               }
             }
             if (!(x instanceof Map)) {
               return;
             }
             x.entrySet().removeIf(e -&gt; e.getKey() =~ /unwanted_key_.*/);
             for (def v: x.values()) {
               iterateAllFields(v);
             }
           }

           iterateAllFields(ctx);
       &#34;&#34;&#34;
       }
     }
   ]
 }
</code></pre><p>We can then test the above script with the following call to the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/simulate-pipeline-api.html">simulate pipeline API</a> as follows.</p>
<pre tabindex="0"><code>POST _ingest/pipeline/remove_unwanted_keys/_simulate
 {
   &#34;docs&#34;: [
     {
       &#34;_source&#34;: {
         &#34;key1&#34;: &#34;first value&#34;,
         &#34;key2&#34;: &#34;some other value&#34;,
         &#34;key3&#34;: &#34;&#34;,
         &#34;unwanted_key_something&#34;: &#34;get rid of this&#34;,
         &#34;unwanted_key_2&#34;: &#34;this too&#34;,
         &#34;sudoc&#34;: {
           &#34;foo&#34;: &#34;abc&#34;,
           &#34;bar&#34;: &#34;&#34;
         }
       }
     }
   ]
 }
</code></pre><p>Which will return the following results, where each field name that started with &ldquo;unwanted_key_&rdquo; has been removed.</p>
<pre tabindex="0"><code>{
   &#34;docs&#34; : [
     {
       &#34;doc&#34; : {
         &#34;_index&#34; : &#34;_index&#34;,
         &#34;_type&#34; : &#34;_doc&#34;,
         &#34;_id&#34; : &#34;_id&#34;,
         &#34;_source&#34; : {
           &#34;key1&#34; : &#34;first value&#34;,
           &#34;key2&#34; : &#34;some other value&#34;,
           &#34;key3&#34; : &#34;&#34;,
           &#34;sudoc&#34; : {
             &#34;bar&#34; : &#34;&#34;,
             &#34;foo&#34; : &#34;abc&#34;
           }
         },
         &#34;_ingest&#34; : {
           &#34;timestamp&#34; : &#34;2020-11-06T11:19:56.839119Z&#34;
         }
       }
     }
   ]
 }
</code></pre><h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>In this blog we have presented two examples of how all elements in a JSON document can be iterated over, regardless of if they are included in the top-level JSON, or within sub-documents or arrays.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/using-kibanas-painless-lab-beta-to-test-an-ingest-processor-script/">
    <span class="title">« Prev</span>
    <br>
    <span>Using Kibana&#39;s Painless Lab (Beta) to test an ingest processor script</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/elasticsearch-too-many-script-compilations/">
    <span class="title">Next »</span>
    <br>
    <span>Understanding and fixing &#34;too many script compilations&#34; errors in Elasticsearch</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Alexander Marquardt</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
